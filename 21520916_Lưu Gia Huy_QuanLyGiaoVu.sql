CREATE DATABASE QLGV
USE QLGV
CREATE TABLE KHOA
(
MAKHOA varchar(4) PRIMARY KEY,
TENKHOA varchar(40),
NGTLAP smalldatetime,
TRGKHOA char(4)
)
CREATE TABLE MONHOC
(
MAMH varchar(10) PRIMARY KEY,
TENMH varchar(40),
TCLT tinyint,
TCTH tinyint,
MAKHOA varchar(4)
FOREIGN KEY(MAKHOA) REFERENCES KHOA(MAKHOA)
)
CREATE TABLE DIEUKIEN
(
MAMH varchar(10),
MAMH_TRUOC varchar(10)
CONSTRAINT PK_DK PRIMARY KEY(MAMH,MAMH_TRUOC)
FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH)
)
CREATE TABLE GIAOVIEN
(
MAGV char(4) PRIMARY KEY,
HOTEN varchar(40),
HOCVI varchar(10),
HOCHAM varchar(10),
GIOITINH varchar(3),
NGSINH smalldatetime,
NGVL smalldatetime,
HESO numeric(4,2),
MUCLUONG money,
MAKHOA varchar(4)
FOREIGN KEY(MAKHOA) REFERENCES KHOA(MAKHOA)
)
CREATE TABLE LOP
(
MALOP char(4) PRIMARY KEY,
TENLOP varchar(40),
TRGLOP char(5),
SISO tinyint,
MAGVCN char(4)
)

CREATE TABLE HOCVIEN
(
MAHV char(5) PRIMARY KEY, 
HO varchar(40),
TEN varchar(10),
NGSINH smalldatetime,
GIOITINH varchar(3),
NOISINH varchar(40),
MALOP char(4),
FOREIGN KEY(MALOP) REFERENCES LOP(MALOP)
)

CREATE TABLE GIANGDAY
(
MALOP char(4),
MAMH varchar(10),
MAGV char(4),
HOCKY tinyint,
NAM smallint,
TUNGAY smalldatetime,
DENNGAY smalldatetime
CONSTRAINT PK_GIANGDAY PRIMARY KEY(MALOP,MAMH)
FOREIGN KEY(MALOP) REFERENCES LOP(MALOP),
FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH),
FOREIGN KEY(MAGV) REFERENCES GIAOVIEN(MAGV)
)
CREATE TABLE KETQUATHI
(
MAHV char(5),
MAMH varchar(10),
LANTHI tinyint,
NGTHI smalldatetime,
DIEM numeric(4,2),
KQUA varchar(10)
CONSTRAINT PK_KQT PRIMARY KEY(MAHV,MAMH,LANTHI)
)

ALTER TABLE HOCVIEN ADD CONSTRAINT CHECK_GTHV CHECK (GIOITINH IN ('Nam', 'Nu'))

ALTER TABLE GIAOVIEN ADD CONSTRAINT CHECK_GTGV CHECK (GIOITINH IN ('Nam', 'Nu'))


ALTER TABLE KETQUATHI ADD CONSTRAINT CHECK_DIEM CHECK (DIEM BETWEEN 0 AND 10)


ALTER TABLE KETQUATHI ADD CONSTRAINT CHECK_KETQUA CHECK
(	
	(KQUA = 'Dat' AND DIEM BETWEEN 5 AND 10)
	OR (KQUA = 'Khong dat' AND DIEM < 5)
)

ALTER TABLE KETQUATHI ADD CONSTRAINT CHECK_LANTHI CHECK (LANTHI <=3)

ALTER TABLE GIANGDAY ADD CONSTRAINT CHECK_HOCKY CHECK (HOCKY BETWEEN 1 AND 3)

ALTER TABLE GIAOVIEN ADD CONSTRAINT CHECK_HOCVI CHECK (HOCVI IN ('CN','KS','Ths','TS','PTS'))


SET DATEFORMAT DMY
INSERT INTO HOCVIEN 
VALUES
('K1101','Nguyen Van','A','27/1/1986','Nam','TpHCM','K11'),
('K1102','Tran Ngoc','Han','14/3/1986','Nu','Kien Giang','K11'),
 ('K1103','Ha Duy','Lap','18/04/1986','Nam','Nghe An','K11'),
 ('K1104','Tran NGoc ','Linh','30/03/1986','Nu','Tay Ninh','K11'),
 ('K1105','Tran Minh','Long','27/02/1986','Nam','TPHCM','K11'),
 ('K1106','Le Nhat ','Minh','24/01/1986','Nam','TPHCM','K11'),
 ('K1107','Nguyen Nhu','Nhut','27/01/1986','Nam','Ha Noi','K11'),
 ('K1108','Nguyen Manh','Tam','27/02/1986','Nam','Kien Giang','K11'),
 ('K1109','Phan Thi Thanh','Tam','27/01/1986','Nu','Vinh Long','K11'),
 ('K1110','Le Hoai','Thuong','05/02/1986','Nu','Can Tho','K11'),
 ('K1111','Le Ha','Vinh','25/12/1986','Nam','Vinh Long','K11'),
 ('K1201','NGuyen Van ','B','11/02/1986','Nam','TPHCM','K12'),
 ('K1202','Nguyen Thi Kim','Duyen','18/01/1986','Nu','TPHCM','K12'),
 ('K1203','Tran Thi Kim','Duyen','17/09/1986','Nu','TPHCM','K12'),
 ('K1204','Truong My','Hanh','19/05/1986','Nu','Dong Nai','K12'),
 ('K1205','Nguyen Thanh','Nam','17/04/1986','Nam','TPHCM','K12'),
 ('K1206','NGuyen Thi Truc ','Thanh','04/03/1986','Nu','Kien Giang','K12'),
 ('K1207','Tran Thi Bich ','Thuy','08/02/1986','Nu','Nghe An','K12'),
 ('K1208','Huynh Thi Kim','Trieu','08/04/1986','Nu','Tay Ninh','K12'),
 ('K1209','Pham Thanh','Trieu','23/02/1986','Nam','TPHCM','K12'),
 ('K1210','Ngo Thanh','Tuan','14/02/1986','Nam','TPHCM','K12'),
 ('K1211','Do Thi','Xuan','09/03/1986','Nu','Ha Noi','K12'),
 ('K1212','Le Thi Phi','Yen','12/03/1986','Nu','TPHCM','K12'),
 ('K1301','NGuyen Thi Kim','Cuc','09/06/1986','Nu','Kien Giang','K13'),
 ('K1302','Truong Thi My','Hien','18/03/1986','Nu','Nghe An','K13'),
 ('K1303','Le Duc','Hien','21/03/1986','Nam','Tay Ninh','K13'),
 ('K1304','Le Quang','Hien','18/04/1986','Nam','TPHCM','K13'),
 ('K1305','Le Thi ','Huong','27/03/1986','Nu','TPHCM','K13'),
 ('K1306','Nguyen Thai','Huu','30/03/1986','Nam','Ha Noi','K13'),
 ('K1307','Tran Minh','Man','28/05/1986','Nam','TPHCM','K13'),
 ('K1308','Huynh Hieu','Nghia','08/04/1986','Nam','Kien Giang','K13'),
 ('K1309','Nguyen Trung ','Nghia','18/01/1987','Nam','Nghe An','K13'),
 ('K1310','Tran Thi Hong','Tham','22/04/1986','Nu','Tay Ninh','K13'),
 ('K1311','Tran Minh','Thuc','04/04/1986','Nam','TPHCM','K13'),
 ('K1312','Nguyen Thi Kim','Yen','07/09/1986','Nu','TPHCM','K13')


  INSERT INTO GIAOVIEN VALUES 
  ('GV01','Ho Thanh Son','PTS','GS','Nam','02/05/1950','11/01/2004',5.00,2250000,'KHMT'),
 ('GV02','Tran Tam Thanh','TS','PGS','Nam','17/02/1965','20/04/2004',4.50,2025000,'HTTT'),
 ('GV03','Do Nghiem Phung','TS','GS','Nu','01/08/1950','23/09/2004',4.00,1800000,'CNPM'),
 ('GV04','Tran Nam Som','TS','PGS','Nam','22/02/1961','12/01/2005',4.50,2025000,'KTMT'),
 ('GV05','Mai Thanh Danh','ThS','GV','Nam','12/03/1958','12/01/2005',3.00,1350000,'HTTT'),
 ('GV06','Tran Doan Hung','TS','GV','Nam','11/03/1953','12/01/2005',4.50,2025000,'KHMT'),
 ('GV07','Nguyen Minh Tien','ThS','GV','Nam','23/11/1971','01/03/2005',4.00,1800000,'KHMT'),
 ('GV08','Le Thi Tran','KS','NULL','Nu','26/03/1974','01/03/2005',1.69,760500,'KHMT'),
 ('GV09','Nguyen To Lan','ThS','GV','Nu','31/12/1966','01/03/2005',4.00,1800000,'HTTT'),
 ('GV10','Le Tran Anh Loan','KS','NULL','Nu','17/07/1972','01/03/2005',1.86,837000,'CNPM'),
 ('GV11','Ho Thanh Tung','CN','GV','Nam','12/01/1980','15/05/2005',2.67,1201500,'MTT'),
 ('GV12','Tran Van Anh','CN','NULL','Nu','29/03/1981','15/05/2005',1.69,760500,'CNPM'),
 ('GV13','Nguyen Linh Dan','CN','NULL','Nu','23/05/1980','15/05/2005',1.69,760500,'KTMT'),
 ('GV14','Truong Minh Chau','ThS','GV','Nu','30/11/1976','15/05/2005',3.00,1350000,'MTT'),
 ('GV15','Le Ha Thanh','ThS','GV','Nam','04/05/1978','15/05/2005',3.00,1350000,'KHMT')

 INSERT INTO LOP VALUES 
 ('K11','Lop 1 Khoa 1','K1108',11,'GV07'),
 ('K12','Lop 2 Khoa 1','K1205',12,'GV09'),
 ('K13','Lop 3 Khoa 1','K1305',12,'GV14')
 INSERT INTO MONHOC VALUES 
 ('THDC','Tin Hoc Dai Cuong',4,1,'KHMT'),
 ('CTRR','Cau TRuc Roi Rac',5,0,'KHMT'),
 ('CSDL','Co So Du Lieu',3,1,'HTTT'),
 ('CTDLGT','Cau Truc Du Lieu Va Giai Thuat',3,1,'KHMT'),
 ('PTTKTT','Phan Tich Thuet Ke Thuat Toan',3,0,'KHMT'),
 ('DHMT','Do Hoa May Tinh',3,1,'KHMT'),
 ('KTMT','Kien Truc May Tinh',3,0,'KTMT'),
 ('TKCSDL','Thiet Ke Co So Du Lieu',3,1,'HTTT'),
 ('PTTKHTTT','Phan Tich Thiet Ke He Thong Thong Tin',4,1,'HTTT'),
 ('HDH','He Dieu Hanh',4,0,'KHMT'),
 ('NMCNPM','Nhap Mon Cong Nghe Phan Mem',3,0,'CNPM'),
 ('LTCFW','Lap Trinh C For Win',3,1,'CNPM'),
 ('LTHDT','Lap Trinh Huong Doi Tuong',3,1,'CNPM')

 INSERT INTO DIEUKIEN VALUES 
 ('CSDL','CTRR'),
 ('CSDL','CTDLGT'),
 ('CTDLGT','THDC'),
 ('PTTKTT','CTDLGT'),
 ('PTTKTT','THDC'),
 ('DHMT','THDC'),
 ('LTHDT','THDC'),
 ('PTTKHTTT','CSDL')

 INSERT INTO GIANGDAY VALUES 
 ('K11','THDC','GV07',1,2006,'02/01/2006','12/05/2006'),
('K12','THDC','GV06',1,2006,'02/01/2006','12/05/2006'),
('K13','THDC','GV15',1,2006,'02/01/2006','12/05/2006'),
('K11','CTRR','GV02',1,2006,'09/01/2006','17/05/2006'),
('K12','CTRR','GV02',1,2006,'09/01/2006','17/05/2006'),
('K13','CTRR','GV08',1,2006,'09/01/2006','17/05/2006'),
('K11','CSDL','GV05',2,2006,'01/06/2006','15/07/2006'),
('K12','CSDL','GV09',2,2006,'01/06/2006','15/07/2006'),
('K13','CTDLGT','GV15',2,2006,'01/06/2006','15/07/2006'),
('K13','CSDL','GV05',3,2006,'01/08/2006','15/12/2006'),
('K13','DHMT','GV07',3,2006,'01/08/2006','15/12/2006'),
('K11','CTDLGT','GV15',3,2006,'01/08/2006','15/12/2006'),
('K12','CTDLGT','GV15',3,2006,'01/08/2007','15/12/2006'),
('K11','HDH','GV04',1,2007,'02/01/2007','18/02/2007'),
('K12','HDH','GV04',1,2007,'02/01/2007','20/03/2007'),
('K11','DHMT','GV07',1,2007,'18/02/2007','20/03/2007')

INSERT INTO KETQUATHI VALUES 
('K1305','CTRR',1,'13/05/2006',10.00,'Dat'),
 ('K1101','CSDL',1,'20/07/2006',10.00,'Dat'),
 ('K1101','CTDLGT',1,'28/12/2006',9.00,'Dat'),
 ('K1101','THDC',1,'20/05/2006',9.00,'Dat'),
 ('K1101','CTRR',1,'13/05/2006',9.50,'Dat'),
 ('K1102','CSDL',1,'20/07/2006',4.00,'Khong Dat'),
 ('K1102','CSDL',2,'27/07/2006',4.25,'Khong Dat'),
 ('K1102','CSDL',3,'10/08/2006',4.50,'Khong Dat'),
 ('K1102','CTDLGT',1,'28/12/2006',4.50,'Khong Dat'),
 ('K1102','CTDLGT',2,'05/01/2007',4.00,'Khong Dat'),
 ('K1102','CTDLGT',3,'15/01/2007',6.00,'Dat'),
 ('K1102','THDC',1,'20/05/2006',5.00,'Dat'),
 ('K1102','CTRR',1,'13/05/2006',7.00,'Dat'),
 ('K1103','CSDL',1,'20/07/2006',3.50,'Khong Dat'),
 ('K1103','CSDL',2,'27/07/2006',8.25,'Dat'),
 ('K1103','CTDLGT',1,'28/12/2006',7.00,'Dat'),
 ('K1103','THDC',1,'20/05/2006',8.00,'Dat'),
 ('K1103','CTRR',1,'13/05/2006',6.25,'Dat'),
 ('K1104','CSDL',1,'20/07/2006',3.75,'Khong Dat'),
 ('K1104','CTDLGT',1,'28/12/2006',4.00,'KHong Dat'),
 ('K1104','THDC',1,'20/05/2006',4.00,'Khong Dat'),
 ('K1104','CTRR',1,'13/05/2006',4.00,'Khong Dat'),
 ('K1104','CTRR',2,'20/05/2006',3.50,'Khong Dat'),
 ('K1104','CTRR',3,'30/06/2006',4.00,'Khong Dat'),
 ('K1201','CSDL',1,'20/07/2006',6.00,'Dat'),
 ('K1201','CTDLGT',1,'28/12/2006','5.00','Dat'),
 ('K1201','THDC',1,'20/05/2006','8.00','Dat'),
 ('K1201','CTRR',1,'13/05/2006',9.00,'Dat'),
 ('K1202','CSDL',1,'20/07/2006',8.00,'dat'),
 ('K1202','CTDLGT',1,'28/12/2006',4.00,'Khong Dat'),
 ('K1202','CTDLGT',2,'05/01/2007',5.00,'Dat'),
 ('K1202','THDC',1,'20/05/2006',4.00,'Khong Dat'),
 ('K1202','THDC',2,'27/05/2006',4.00,'Khong Dat'),
 ('K1202','CTRR',1,'13/05/2006',3.00,'Khong Dat'),
 ('K1202','CTRR',2,'20/05/2006',4.00,'Khong dat'),
 ('K1202','CTRR',3,'30/06/2006',6.25,'Dat'),
 ('K1203','CSDL',1,'20/07/2006',9.25,'Dat'),
 ('K1203','CTDLGT',1,'28/12/2006',9.50,'Dat'),
 ('K1203','THDC',1,'20/05/2006',10,'Dat'),
 ('K1203','CTRR',1,'13/05/2006',10,'Dat'),
 ('K1204','CSDL',1,'20/07/2006',8.50,'Dat'),
 ('K1204','CTDLGT',1,'28/12/2006',6.25,'dat'),
 ('K1204','THDC',1,'20/05/2006',4.00,'Khong Dat'),
 ('K1204','CTRR',1,'13/05/2006',6.00,'Dat'),
 ('K1301','CSDL',1,'20/12/2006',4.25,'Khong Dat'),
 ('K1301','CTDLGT',1,'25/07/2006',8.00,'Dat'),
 ('K1301','THDC',1,'20/05/2006',7.75,'Dat'),
 ('K1301','CTRR',1,'13/05/2006',8.00,'Dat'),
 ('K1302','CSDL',1,'20/12/2006',6.75,'Dat'),
 ('K1302','CTDLGT',1,'13/05/2006',5.00,'Dat'),
 ('K1302','THDC',1,'20/05/2006',8.00,'Dat'),
 ('K1302','CTRR',1,'13/05/2006',8.50,'Dat'),
 ('K1303','CSDL',1,'20/12/2006',4.00,'Khong Dat'),
 ('K1303','CTDLGT',1,'25/07/2006',4.50,'Khong Dat'),
 ('K1303','CTDLGT',2,'07/08/2006',4.00,'Khong Dat'),
 ('K1303','CTDLGT',3,'15/08/2006',4.25,'Khong Dat'),
 ('K1303','THDC',1,'20/05/2006',4.50,'Khong Dat'),
 ('K1303','CTRR',1,'13/05/2006',3.25,'Khong Dat'),
 ('K1303','CTRR',2,'20/05/2006',5.00,'Dat'),
 ('K1304','CSDL',1,'20/12/2006',7.75,'Dat'),
 ('K1304','CTDLGT',1,'25/07/2006',9.75,'Dat'),
 ('K1304','THDC',1,'20/05/2006',5.50,'Dat'),
 ('K1304','CTRR',1,'13/05/2006',5.00,'Dat'),
 ('K1305','CSDL',1,'20/12/2006',9.25,'Dat'),
 ('K1305','CTDLGT',1,'25/07/2006',10.00,'Dat'),
 ('K1305','THDC',1,'20/05/2006',8.00,'Dat')

 INSERT INTO KHOA 
 VALUES 
 ('KHMT','Khoa Hoc May Tinh', '07/06/2005' ,'GV01'),
 ('HTTT','He Thong Thong Tin','07/06/2005','GV02'),
 ('CNPM','Cong Nghe Phan Mem','07/06/2005','GV04'),
 ('MTT','Mang Va Truyen Thong','20/10/2005','GV03'),
 ('KTMT','Ky Thuat May Tinh','20/12/2005',NULL) 

 ALTER TABLE HOCVIEN ADD GHICHU VARCHAR(50), DIEMTB NUMERIC(4,2), XEPLOAI VARCHAR(10)

 select * from DIEUKIEN
 select * from GIANGDAY
 select * from GIAOVIEN
 select * from HOCVIEN
 select * from KETQUATHI
 select * from KHOA
 select * from LOP
 select * from MONHOC


 --I.11
ALTER TABLE HOCVIEN ADD CONSTRAINT HV_TUOI CHECK ( (YEAR(GETDATE()) - YEAR(NGSINH)) >=18)

--I.12
ALTER TABLE GIANGDAY ADD CONSTRAINT CHECK_GIANGDAY CHECK (TUNGAY < DENNGAY)

--I.13
ALTER TABLE GIAOVIEN ADD CONSTRAINT CHECK_TUOILAM CHECK (YEAR(NGVL) - YEAR(NGSINH) >= 22)

--I.14
ALTER TABLE MONHOC ADD CONSTRAINT CHECK_TINCHI CHECK (ABS(TCLT - TCTH) <= 3)

--III.1
SELECT  MAHV, (HO+TEN) HOTEN, NGSINH, HOCVIEN.MALOP
FROM  HOCVIEN, Lop
WHERE HOCVIEN.MAHV = LOP.TRGLOP

--III.2
SELECT HOCVIEN.MAHV,(HO+TEN) HOTEN,LANTHI,DIEM
FROM KETQUATHI,HOCVIEN
WHERE HOCVIEN.MAHV=KETQUATHI.MAHV AND MaMH = 'CTRR' AND MaLop = 'K12'
ORDER BY TEN,HO

--III.3
SELECT HocVien.MaHV, (Ho+' '+Ten) HoTen, TenMH
FROM KetQuaThi, MonHoc, HocVien
WHERE KetQuaThi.MaMH = MonHoc.MaMH
	AND KetQuaThi.MaHV = HocVien.MaHV
	AND LanThi = 1 AND KQua = 'Dat'
--III.4
SELECT HocVien.MaHV, (Ho+' '+Ten) HoTen
FROM KetQuaThi,  HocVien
WHERE KetQuaThi.MaHV = HocVien.MaHV
	AND LanThi = 1 AND KQua = 'KHONG DAT' AND MALOP='K11' AND MaMH = 'CTRR'
--III.5
SELECT DISTINCT HocVien.MaHV, (Ho+' '+Ten) HoTen
FROM HocVien, KetQuaThi
WHERE HocVien.MaHV = KetQuaThi.MaHV
	AND MaLop like 'K%'  AND MaMH = 'CTRR'  AND NOT EXISTS
		(SELECT * FROM KetQuaThi 
		WHERE KQua = 'Dat' AND MaMH = 'CTRR' AND MaHV = HocVien.MaHV)


--II.1
UPDATE GIAOVIEN SET HESO=HESO*1.2 WHERE MAGV IN 
( SELECT TRGKHOA FROM KHOA, GIAOVIEN WHERE KHOA.MAKHOA=GIAOVIEN.MAKHOA)
SELECT * FROM GIAOVIEN

--II.2
UPDATE HOCVIEN 
SET DIEMTB = 
(
	SELECT AVG(DIEM)
	FROM KETQUATHI
	WHERE LANTHI= (SELECT MAX(LANTHI) 
					FROM KETQUATHI KQ	
					WHERE KQ.MAHV=KETQUATHI.MAHV
					GROUP BY MAHV )
	GROUP BY MAHV
	HAVING MAHV=HOCVIEN.MAHV
)

--II.3
UPDATE HOCVIEN
SET GHICHU ='CAMTHI'
WHERE MAHV IN ( SELECT MAHV FROM KETQUATHI WHERE LANTHI=3 AND DIEM <5)


--II.4
UPDATE HOCVIEN
SET XEPLOAI =
(
	CASE
		WHEN DIEMTB >= 9 THEN 'XS'
		WHEN DIEMTB >=8 AND DIEMTB <9 THEN 'G'
		WHEN DIEMTB >=6.5 AND DIEMTB <8 THEN 'K'
		WHEN DIEMTB >=5 AND DIEMTB <6.5 THEN 'TB'
		WHEN DIEMTB <5  THEN 'Y'
	END
)

--III.6
SELECT DISTINCT MONHOC.TENMH 
FROM MONHOC,GIANGDAY,GIAOVIEN
WHERE MONHOC.MAMH=GIANGDAY.MAMH 
	AND GIAOVIEN.MAGV=GIANGDAY.MAGV 
	AND GIAOVIEN.HOTEN='Tran Tam Thanh' 
	AND GIANGDAY.HOCKY=1 
	AND GIANGDAY.NAM=2006

--III.7
SELECT MONHOC.MAMH, MONHOC.TENMH
FROM LOP,MONHOC,GIANGDAY
WHERE GIANGDAY.MALOP=LOP.MALOP
	AND GIANGDAY.MAMH=MONHOC.MAMH
	AND LOP.MALOP='K11'
	AND GIANGDAY.HOCKY=1 
	AND GIANGDAY.NAM=2006

--III.8
SELECT (HO + ' ' +TEN) HOTEN
FROM GIANGDAY,HOCVIEN,LOP,GIAOVIEN,MONHOC
WHERE GIAOVIEN.HOTEN='Nguyen To Lan'
	AND MONHOC.TENMH='Co So Du Lieu'
	AND GIANGDAY.MALOP=LOP.MALOP
	AND GIANGDAY.MAMH=MONHOC.MAMH
	AND GIAOVIEN.MAGV=GIANGDAY.MAGV
	AND LOP.TRGLOP=HOCVIEN.MAHV
	


--III.9
SELECT MONHOC.MAMH,TENMH
FROM MONHOC
WHERE MAMH IN 
			(
				SELECT DK.MAMH_TRUOC
				FROM MONHOC M, DIEUKIEN DK
				WHERE M.TENMH='Co So Du Lieu'
				AND M.MAMH=DK.MAMH
			)

--III.10
SELECT MONHOC.MAMH,TENMH
FROM MONHOC
WHERE MAMH IN 
			(
				SELECT DK.MAMH
				FROM MONHOC M, DIEUKIEN DK
				WHERE M.TENMH='Cau TRuc Roi Rac'
				AND M.MAMH=DK.MAMH_TRUOC
			)

--III.11
--11.	Tìm họ tên giáo viên dạy môn CTRR 
--cho cả hai lớp “K11” và “K12” trong cùng học kỳ 1 năm 2006.
SELECT HOTEN
FROM
	GIAOVIEN,GIANGDAY,MONHOC
WHERE
	GIAOVIEN.MAGV=GIANGDAY.MAGV
	AND GIANGDAY.MAMH=MONHOC.MAMH
	AND MaLop = 'K11'
	AND HocKy = 1 AND Nam = 2006
	AND MONHOC.TENMH='Cau TRuc Roi Rac'
INTERSECT 
	(SELECT HOTEN
	FROM
		GIAOVIEN,GIANGDAY,MONHOC
	WHERE
		GIAOVIEN.MAGV=GIANGDAY.MAGV
		AND GIANGDAY.MAMH=MONHOC.MAMH
		AND MALOP = 'K12'
		AND HOCKY = 1 AND Nam = 2006
		AND MONHOC.TENMH='Cau TRuc Roi Rac')
--III.12
SELECT  HocVien.MaHV, (Ho+' '+Ten) HoTen
FROM    HocVien, KetQuaThi
WHERE
	HocVien.MaHV = KetQuaThi.MaHV
	AND MaMH = 'CSDL' 
	AND LanThi = 1 
	AND KQua = 'Khong Dat'
	AND NOT EXISTS 
				(SELECT * 
				FROM KetQuaThi 
				WHERE LanThi > 1 
				AND KetQuaThi.MaHV = HocVien.MaHV)
--III.13
SELECT MAGV,HOTEN
FROM GIAOVIEN
WHERE MAGV NOT IN ( SELECT MAGV FROM GIANGDAY )

--III.14
SELECT MAGV, HOTEN
FROM GIAOVIEN
WHERE NOT EXISTS 
				(SELECT *
				FROM MONHOC
				WHERE MONHOC.MAKHOA=GIAOVIEN.MAKHOA
				AND NOT EXISTS 
							( SELECT *
							FROM GIANGDAY
							WHERE GIANGDAY.MAMH=MONHOC.MAMH
							AND GIANGDAY.MAGV=GIAOVIEN.MAGV))
							

--III.15
SELECT (HO + ' ' + TEN) HOTEN
FROM KETQUATHI,HOCVIEN
WHERE KETQUATHI.MAHV=HOCVIEN.MAHV
	AND MALOP='K11'
	AND (( KETQUATHI.LANTHI >3 AND KETQUATHI.KQUA='Khong Dat')
			OR ( LANTHI =2 AND DIEM =5 ))

--III.16

SELECT HOTEN
FROM GIAOVIEN GV, GIANGDAY GD
WHERE GV.MAGV = GD.MAGV
	AND GD.MAMH='CTRR'
GROUP BY NAM,HOCKY,HOTEN
HAVING COUNT(*) >=2
	

--III.17

SELECT HOCVIEN.MAHV,HO+' '+TEN HOTEN,DIEM
FROM KETQUATHI,HOCVIEN
WHERE HOCVIEN.MAHV=KETQUATHI.MAHV
	AND MAMH='CSDL'
	AND LANTHI= 
			(SELECT MAX(LANTHI) 
			FROM KETQUATHI KQ 
			WHERE KQ.MAHV=HOCVIEN.MAHV
				AND MAMH='CSDL'
			GROUP BY MAHV)

--III.18
SELECT HOCVIEN.MAHV,HO+' '+TEN HOTEN,DIEM
FROM KETQUATHI,HOCVIEN,MONHOC
WHERE HOCVIEN.MAHV=KETQUATHI.MAHV
	AND MONHOC.MAMH=KETQUATHI.MAMH
	AND MONHOC.TENMH='Co So Du Lieu'
	AND DIEM= 
			(SELECT MAX(DIEM) 
			FROM KETQUATHI KQ , MONHOC
			WHERE KQ.MAHV=HOCVIEN.MAHV
				AND MONHOC.MAMH=KQ.MAMH
				AND MONHOC.TENMH='Co So Du Lieu'
			GROUP BY MAHV)


--III.19
SELECT MAKHOA,TENKHOA
FROM KHOA
WHERE NGTLAP= (SELECT MIN(NGTLAP) FROM KHOA )

--III.20
SELECT COUNT(*) 'Số lượng giáo viên có học hàm là "GS","PGS"'
FROM GIAOVIEN
WHERE HOCHAM IN ('GS','PGS')

--III.21
SELECT MAKHOA,HOCVI, COUNT(*) 'Số giáo viên'
FROM GIAOVIEN
GROUP BY MAKHOA,HOCVI
ORDER BY MAKHOA

--III.22
SELECT MAMH,KQUA, COUNT(*) 'Số học sinh'
FROM KETQUATHI
GROUP BY MAMH,KQUA
ORDER BY MAMH

--III.23
SELECT GIAOVIEN.MAGV, GIAOVIEN.HOTEN
FROM GIAOVIEN 
WHERE GIAOVIEN.MAGV IN (SELECT MAGVCN 
						FROM LOP 
						WHERE MAGVCN IN (SELECT  MAGV 
										FROM GIANGDAY 
										WHERE LOP.MALOP=GIANGDAY.MALOP))

--III.24
SELECT HO+ ' ' +TEN 'Họ tên lớp trưởng của lớp có sỉ số cao nhất'
FROM HOCVIEN
WHERE MAHV IN ( SELECT TRGLOP
				FROM LOP
				WHERE SISO = ( SELECT MAX(SISO) FROM LOP))

--III.25
SELECT HO + ' ' + TEN 'Họ tên trưởng lớp thi không đạt quá 3 môn'
FROM
	HOCVIEN,LOP,KETQUATHI
WHERE
	HOCVIEN.MAHV = LOP.TRGLOP
	AND HOCVIEN.MAHV = KETQUATHI.MAHV
	AND KQUA = 'Khong Dat'
	AND HOCVIEN.MAHV NOT IN (SELECT K.MAHV 
							FROM KETQUATHI K
							WHERE K.KQUA='Dat')
GROUP BY 
	TrgLop, Ho, Ten,MAMH
HAVING 
	COUNT(*) > 3

--III.26
SELECT
	HOCVIEN.MAHV, HO+' '+TEN AS HOTEN
FROM
	HOCVIEN , KETQUATHI
WHERE
	HOCVIEN.MAHV = KETQUATHI.MAHV
	AND DIEM >= 9
GROUP BY
	HOCVIEN.MAHV, HO, TEN
HAVING
	COUNT(*) >= ALL(SELECT COUNT(*) FROM KETQUATHI WHERE DIEM >= 9 GROUP BY MAHV) 

--III.27
SELECT
	MALOP, MAHV, HOTEN
FROM
(
	SELECT
		MALOP, HOCVIEN.MAHV, (HO+' '+TEN) HOTEN, RANK() OVER (PARTITION BY MALOP ORDER BY COUNT(*) DESC) AS XH
	FROM
		HOCVIEN, KETQUATHI
	WHERE
		HOCVIEN.MAHV = KETQUATHI.MAHV
		AND DIEM >= 9
	GROUP BY
		MALOP, HOCVIEN.MAHV, HO, TEN
) AS A
WHERE
	A.XH = 1

--III.28
SELECT MAGV, COUNT(DISTINCT MAMH) 'Số môn học', COUNT(DISTINCT MALOP) 'Số lớp'
FROM GIANGDAY
GROUP BY MAGV

--III.29
SELECT HocKy, Nam, A.MaGV, HoTen
FROM GiaoVien,
(
	SELECT 
		HocKy, Nam, MaGV, RANK() OVER (PARTITION BY HocKy, Nam ORDER BY COUNT(*) DESC) AS XepHang
	FROM GiangDay
	GROUP BY HocKy, Nam, MaGV
) AS A
WHERE
	A.MAGV = GiaoVien.MAGV
	AND XepHang = 1
ORDER BY
	Nam, HocKy

--III.30
SELECT
	MonHoc.MaMH, TenMH
FROM
	MonHoc, KetQuaThi
WHERE
	MonHoc.MaMH = KetQuaThi.MaMH
	AND LanThi = 1
	AND KQua = 'Khong Dat'
GROUP BY 
	MonHoc.MaMH, TenMH
HAVING
	COUNT(*) >= ALL (SELECT COUNT(*) FROM KetQuaThi WHERE LanThi = 1 AND KQua = 'Khong Dat' GROUP BY MAMH)

--III.31
SELECT DISTINCT
	HocVien.MaHV, Ho+' '+Ten HoTen
FROM
	HocVien, KetQuaThi
WHERE
	HocVien.MaHV = KetQuaThi.MaHV
	AND NOT EXISTS
	(
		SELECT *
		FROM KetQuaThi
		WHERE LanThi = 1
		AND KQua = 'Khong Dat'
		AND MaHV = HocVien.MaHV
	)

--III.32
SELECT DISTINCT
	HocVien.MaHV, (Ho+' '+Ten) HoTen
FROM
	HocVien, KetQuaThi
WHERE
	HocVien.MaHV = KetQuaThi.MaHV
	AND NOT EXISTS
	(
		SELECT *
		FROM KetQuaThi
		WHERE LanThi = (SELECT MAX(LanThi) FROM KetQuaThi WHERE MaHV = HocVien.MaHV GROUP BY MaHV)
		AND KQua = 'Khong Dat'
		AND MaHV = HocVien.MaHV
	)

--III.33
SELECT MaHV, (Ho+' '+Ten) HoTen
FROM HocVien
WHERE NOT EXISTS
(
	SELECT *
	FROM MonHoc
	WHERE NOT EXISTS
	(
		SELECT *
		FROM KetQuaThi
		WHERE
			KetQuaThi.MaMH = MonHoc.MaMH
			AND KetQuaThi.MaHV = HocVien.MaHV
			AND LanThi = 1 AND KQua = 'Dat'
	)
)

--III.34
SELECT MaHV, (Ho+' '+Ten) HoTen
FROM HocVien
WHERE NOT EXISTS
(
	SELECT *
	FROM MonHoc
	WHERE NOT EXISTS
	(
		SELECT *
		FROM KetQuaThi
		WHERE
			KetQuaThi.MaMH = MonHoc.MaMH
			AND KetQuaThi.MaHV = HocVien.MaHV
			AND LanThi = (SELECT MAX(LanThi) FROM KetQuaThi WHERE MaHV = HocVien.MaHV GROUP BY MaHV)
			AND KQua = 'Dat'
	)
)

--III.35
SELECT MaMH, MaHV, HoTen
FROM
(
	SELECT
		MaMH, HocVien.MaHV, (Ho+' '+Ten) HoTen, RANK() OVER (PARTITION BY MaMH ORDER BY MAX(Diem) DESC) AS XepHang
	FROM
		HocVien, KetQuaThi
	WHERE
		HocVien.MaHV = KetQuaThi.MaHV
		AND LanThi = (SELECT MAX(LanThi) FROM KetQuaThi WHERE MaHV = HocVien.MaHV GROUP BY MaHV)
	GROUP BY
		MaMH, HocVien.MaHV, Ho, Ten
) AS A
WHERE XepHang = 1

--I.9
GO
CREATE TRIGGER trg_ins_udt_LopTruong ON LOP
FOR INSERT, UPDATE
AS
BEGIN
	IF NOT EXISTS (SELECT * FROM INSERTED I, HOCVIEN HV
	WHERE I.TRGLOP = HV.MAHV AND I.MALOP = HV.MALOP)
	BEGIN
		PRINT 'Error: Lop truong cua mot lop phai la hoc vien cua lop do'
		ROLLBACK TRANSACTION
	END
END

GO
CREATE TRIGGER trg_del_HOCVIEN ON HOCVIEN
FOR DELETE
AS
BEGIN
	IF EXISTS (SELECT * FROM DELETED D, LOP L 
	WHERE D.MAHV = L.TRGLOP AND D.MALOP = L.MALOP)
	BEGIN
		PRINT 'Error: Hoc vien hien tai dang la truong lop'
		ROLLBACK TRANSACTION
	END
END

--I.10
GO
CREATE TRIGGER trg_ins_udt_KHOA ON KHOA
FOR INSERT, UPDATE
AS
BEGIN
	IF NOT EXISTS (SELECT * FROM INSERTED I, GIAOVIEN GV
	WHERE I.TRGKHOA = GV.MAGV AND I.MAKHOA = GV.MAKHOA)
	BEGIN
		PRINT 'Error: TRUONG KHOA PHAI LA GIAO VIEN CUA CAI KHOA DO'
		ROLLBACK TRANSACTION
	END
END

GO
CREATE TRIGGER trg_del_GIAOVIEN ON GIAOVIEN
FOR DELETE
AS
BEGIN
	IF EXISTS (SELECT * FROM DELETED D, KHOA K 
	WHERE D.MAGV = K.TRGKHOA AND D.MAKHOA = K.MAKHOA)
	BEGIN
		PRINT 'Error: GIAO VIEN HIEN TAI LA TRUONG KHOA'
		ROLLBACK TRANSACTION
	END
END

--I.15


